<!--
  $Id$
-->
<project name="drjava" default="test">
  <property name="build.sysclasspath" value="last" />

  <property name="jsr14_classpath" value="lib/jsr14.jar" />

  <!-- srcroot is the base directory of the source, 4 packages back -->
  <property name="srcroot" value="../../../.." />

  <!-- built is where the compiled classes go -->
  <property name="built" value="${srcroot}/../built/" />

  <!-- projpath is the path from srcroot to the root directory of this project
  -->
  <property name="projpath" value="edu/rice/cs/${ant.project.name}" />

  <!-- put a jar in this directory after each commit -->
  <property name="jars_dir" value="/home/javaplt/public_html/drjava/builds" />

  <!-- put new javadoc in this directory after each commit -->
  <property name="public_javadoc_dir" value="/home/javaplt/public_html/javadoc/${ant.project.name}" />

  <!-- put javadoc in this directory if generating private javadoc -->
  <property name="private_javadoc_dir" value="${srcroot}/../javadoc/${ant.project.name}" />

  <property name="jarfile" value="${srcroot}/../drjava.jar" />
  <property name="manifest" value="manifest" />

  <!-- classpath to use everywhere. -->
  <path id="classpath">
    <pathelement location="${built}" />

    <fileset dir="lib">
      <include name="**/*.jar"/>
    </fileset>

    <pathelement path="${java.class.path}" />
  </path>

  <!-- Init target. All others depend on it. Initialize the directory. -->
  <target name="init">
    <available type="file" file="${jsr14_classpath}" property="jsr14_ok" />
    <antcall target="check_for_jsr14" />

    <tstamp /> <!-- Ant requires us to make time stamp -->
    <mkdir dir="${built}" /> <!-- Make the built directory -->

    <pathconvert refid="classpath"
                 property="classpath_text"
                 pathsep="${path.separator}" />

  </target>

  <target name="check_for_jsr14" unless="jsr14_ok">
    <fail message=" JSR-14 prototype compiler was not found. A jar file containing the compiler must be put in ${basedir}/lib/jsr14.jar. (We can not distribute the jar for licensing reasons.) To download jsr14, go to http://developer.java.sun.com/developer/earlyAccess/adding_generics. Then unzip the file you downloaded, and move the included javac.jar to ./lib/jsr14.jar." />
  </target>

  <!-- Reconcile source with CVS archive -->
  <target name="update" depends="init">
    <cvs command="update -d -P" />
  </target>

  <target name="make-version-stamp">
    <tstamp /> <!-- get new time stamp to use for CVS tag -->

    <!-- Create new Version.java, filling in date and time. -->
    <filter token="DATE" value="${DSTAMP}" />
    <filter token="TIME" value="${TSTAMP}" />
    <copy file="Version.orig"
          tofile="Version.java" 
          overwrite="yes"
          filtering="yes" />
  </target>


  <!-- Commit source to CVS archive
       Before doing do, we update our copy with the CVS copy. This ensures that
       if there were any clashes, we have to resolve them now. Then we
       recompile (from scratch) and retest. If this all succeeds, we can commit.

       After committing, we tag the build we just made with the tag
       projectname-date-time.
  -->
  <target name="commit" depends="clean, update, test">
    <antcall target="make-version-stamp" />

    <!-- recompile to make new version number get into code. -->
    <antcall target="compile" />

    <cvs command="commit" />

    <property name="version-tag"
              value="${ant.project.name}-${DSTAMP}-${TSTAMP}" />

    <cvs command="tag -c ${version-tag}" quiet="true" />

    <echo message="New version ${version-tag} committed to CVS." />
    <echo message="Note: This version has not yet been released. To release it, type the following on a CS net host (sun or frosty): ant -Dversion-tag=${version-tag} release" />

  </target>

  <!-- generate jar and javadoc
       Requires version-tag to be set (via command line -Dversion-tag=)
       For example, to release drjava-20020101-0000, you'd type:

       ant -Dversion-tag=drjava-20020101-0000 release

       Note: Release must be run on CS net
  -->
  <target name="release" if="version-tag" depends="update,compile">
    <antcall target="jar">
      <param name="jarfile" value="${jars_dir}/${version-tag}.jar" />
    </antcall>

    <!-- generate javadoc for the committed version! -->
    <antcall target="generate_javadoc">
      <param name="javadoc_dir" value="${public_javadoc_dir}" />
      <param name="javadoc_title" value="${version-tag}" />
    </antcall>

    <!-- give group permissions to write over the javadoc -->
    <chmod perm="g+w,a+rX" dir="${public_javadoc_dir}" type="both" includes="**" />
  </target>

  <!-- commit this version and then release it. only will work on cs net. -->
  <target name="commit-and-release">
    <antcall target="commit" />
    <antcall target="release" />
  </target>


  <!-- Compile. We have to start at srcroot and then selectively include
       just this project in order for it to realize what files have already
       been compiled (preventing needless recompilation)
  -->
  <target name="compile" depends="init">
  <!--
    <javac srcdir="${srcroot}"
           includes="${projpath}/**/*java"
           destdir="${built}" 
           bootclasspath="${jsr14_classpath}:${java.home}/lib/rt.jar"
           target="1.1"
           debug="on"
           optimize="off">
            <classpath refid="classpath" />
    </javac>
  -->
    <apply executable="java" failonerror="yes" parallel="yes" type="file">
      <arg value="-classpath" />
      <arg value="${classpath_text}" />
      <arg value="com.sun.tools.javac.Main" />

      <arg value="-sourcepath" />
      <arg value="${srcroot}" />

      <arg value="-d" />
      <arg value="${built}" />

      <arg value="-target" />
      <arg value="1.1" />

      <arg value="-g" />
      
      <fileset dir="${srcroot}">
        <include name="${projpath}/**/*.java" />
      </fileset>
    </apply>


    <rmic base="${built}"
          classname="edu.rice.cs.drjava.model.repl.newjvm.InterpreterJVM" />

    <rmic base="${built}"
          classname="edu.rice.cs.drjava.model.repl.newjvm.MainJVM" />
  </target>

  <!-- Unit test -->
  <target name="test-only">
    <antcall target="run-tests">
      <param name="test-spec" value="" />
    </antcall>
  </target>

  <!-- Now you can run a subset of tests by doing:
       ant -Dtest-spec=XXX run-tests

       Where XXX is the substring that must be in the test's file name
       in order to run it
  -->
  <target name="run-tests" if="test-spec">
    <junit printsummary="yes" haltonerror="yes" haltonfailure="yes" fork="no">
      <!-- propogate the same classpath. not sure why it doesn't
           happen by default!
      -->
      <classpath refid="classpath" />

      <!-- This makes JUnit display info about each test to console -->
      <formatter type="plain" usefile="no" />

      <!-- This makes JUnit run all test classes. It figures out which ones
           automatically, without needing AllTests classes.
      -->
      <batchtest>
        <!-- The root of the fileset must be where edu/ is. -->
        <fileset dir="${srcroot}">
          <!-- Include only from projpath to only get classes in this project!
          -->
          <include name="${projpath}/**/*${test-spec}*Test.java" />
          <exclude name="**/AllTests.java" />
          <exclude name="**/Test.java" />
        </fileset>
      </batchtest>
    </junit>
  </target>

  <!-- Unit test -->
  <target name="test" depends="compile, test-only">
  </target>

  <!-- Makes a jar with dependencies. No tests are included. -->
  <target name="jar">
    <!-- copy external dependencies -->
    <zip zipfile="${jarfile}">
      <zipfileset src="lib/gj-util.jar" />
      <zipfileset src="lib/dynamicjava.jar" />
    </zip>

    <jar jarfile="${jarfile}" manifest="${manifest}" update="true" >
      <fileset dir="${built}" excludes="**/*Test.class">
        <include name="${projpath}/**" />
        <include name="edu/rice/cs/util/**" />
      </fileset>
    </jar>
  </target>

  <!-- Run the program! -->
  <target name="run" depends="compile">
    <java fork="true" classname="edu.rice.cs.drjava.DrJava">
      <classpath refid="classpath" />
    </java>
  </target>

  <!-- generate private javadoc for current uncommitted version -->
  <target name="javadoc" depends="init">
    <tstamp />
    <antcall target="generate_javadoc">
      <param name="javadoc_dir" value="${private_javadoc_dir}" />
      <param name="javadoc_title" value="${user.name}-uncommitted-${DSTAMP}-${TSTAMP}" />
    </antcall>
  </target>

  <!-- Generate javadoc, removing generics references first.
       The property javadoc_dir must be set when calling this.
       The property javadoc_title must be set when calling this.
  -->
  <target name="generate_javadoc" if="javadoc_dir" depends="init">
    <delete dir="${javadoc_dir}" />
    <mkdir dir="${javadoc_dir}" />

    <mkdir dir="${javadoc_dir}/src" />

    <!-- run jsr14 from jsr14.jar to make non-generic source. -->
    <apply executable="java" failonerror="yes" parallel="yes" type="file">
      <arg value="-classpath" />
      <arg value="${classpath_text}" />
      <arg value="com.sun.tools.javac.Main" />

      <arg value="-sourcepath" />
      <arg value="${srcroot}" />

      <!-- Generate Java source without generics -->
      <arg value="-s" />

      <arg value="-d" />
      <arg value="${javadoc_dir}/src" />
      
      <fileset dir="${srcroot}">
        <include name="${projpath}/**/*.java" />
      </fileset>
    </apply>

    <!-- Now we need to copy the package.htmls over to the
         directory with the non-generic sources. -->
    <copy todir="${javadoc_dir}/src">
      <fileset dir="${srcroot}">
        <include name="${projpath}/**/package.html" />
      </fileset>
    </copy>

    <javadoc sourcepath="${javadoc_dir}/src"
             destdir="${javadoc_dir}"
             packagenames="edu.rice.cs.${ant.project.name}.*"
             Private="yes"
             Use="yes"
             Version="yes"
             Windowtitle="${javadoc_title}">

      <classpath refid="classpath" />

      <link href="http://www.cs.rice.edu/~javaplt/javadoc/util" />
      <link href="http://www.cs.rice.edu/~javaplt/javadoc/java-api" />
      <link href="http://www.cs.rice.edu/~javaplt/javadoc/junit" />
      <link href="http://www.cs.rice.edu/~javaplt/javadoc/dynamicjava" />
    </javadoc>

    <!-- delete source we generated without generics -->
    <delete dir="${javadoc_dir}/src" />
  </target>

  <!-- Delete all generated files (only for this project!) -->
  <target name="clean">
    <delete dir="${private_javadoc_dir}" />
    <delete dir="${built}/${projpath}" />
    <delete file="${jarfile}" />
  </target>
</project>

